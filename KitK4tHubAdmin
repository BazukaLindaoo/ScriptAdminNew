-- SCRIPT FINAL: Brookhaven-ready
-- Tags apenas para Dono e Moderador (azul). Painel autom√°tico s√≥ para autorizados.
local Players = game:GetService("Players")
local TextChatService = game:GetService("TextChatService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- Carregar lista de autorizados
local AUTHORIZED_PLAYERS = nil
pcall(function()
    AUTHORIZED_PLAYERS = loadstring(game:HttpGet("https://raw.githubusercontent.com/KitK4tHub/users/refs/heads/main/users/allow.lua"))()
end)

-- Tags especiais
local SPECIAL_TAGS = {
    ["Breno010L"] = "üëë Dono KitK4t",
    ["shawnlovebazuka"] = "üíé Subdona KitK4t"
}

local ActiveTags = {}

-- Fun√ß√£o segura para checar autoriza√ß√£o
local function SafeIsAuthorized(name)
    if type(AUTHORIZED_PLAYERS) ~= "table" then return false end
    for _, v in ipairs(AUTHORIZED_PLAYERS) do
        if tostring(v):lower() == tostring(name):lower() then
            return true
        end
    end
    return false
end

local function IsPlayerAuthorized()
    if SPECIAL_TAGS[LocalPlayer.Name] then return true end
    return SafeIsAuthorized(LocalPlayer.Name)
end

-- Efeito visual
local function CreateBillCipherEffect()
    local char = LocalPlayer.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    local fire = Instance.new("Fire")
    fire.Color = Color3.fromRGB(0, 100, 255)
    fire.SecondaryColor = Color3.fromRGB(0, 200, 255)
    fire.Size = 8
    fire.Heat = 2
    fire.Parent = hrp
    task.delay(2, function() if fire and fire.Parent then fire:Destroy() end end)
end

-- Remove tag
local function RemovePlayerTag(playerName)
    if ActiveTags[playerName] then
        local tagData = ActiveTags[playerName]
        if tagData.Billboard and tagData.Billboard.Parent then
            pcall(function() tagData.Billboard:Destroy() end)
        end
        ActiveTags[playerName] = nil
    end
end

-- Cria tag azul (somente autorizados)
local function CreatePlayerTag(playerName, tagText)
    local targetPlayer = Players:FindFirstChild(playerName)
    if not targetPlayer then return end
    local char = targetPlayer.Character
    if not char then return end
    local head = char:FindFirstChild("Head")
    if not head then return end

    RemovePlayerTag(playerName)

    local billboard = Instance.new("BillboardGui")
    billboard.Name = "KitK4tTag"
    billboard.Adornee = head
    billboard.Size = UDim2.new(0, 150, 0, 30)
    billboard.StudsOffset = Vector3.new(0, 2.5, 0)
    billboard.AlwaysOnTop = true
    billboard.MaxDistance = 120
    billboard.Parent = head

    local bg = Instance.new("Frame")
    bg.Size = UDim2.new(1, 0, 1, 0)
    bg.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    bg.BackgroundTransparency = 0.25
    bg.BorderSizePixel = 0
    bg.Parent = billboard

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = bg

    local txt = Instance.new("TextLabel")
    txt.Size = UDim2.new(1, -8, 1, -8)
    txt.Position = UDim2.new(0, 4, 0, 4)
    txt.BackgroundTransparency = 1
    txt.Text = tagText
    txt.TextColor3 = Color3.fromRGB(255, 255, 255)
    txt.TextSize = 12
    txt.Font = Enum.Font.GothamBold
    txt.TextStrokeTransparency = 0
    txt.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    txt.Parent = bg

    local glow = Instance.new("UIStroke")
    glow.Color = Color3.fromRGB(0, 100, 255)
    glow.Thickness = 1
    glow.Parent = bg

    ActiveTags[playerName] = { Billboard = billboard, TagText = tagText }
end

-- Aplicar tag apenas se autorizado (Dono/Subdona/Moderador)
local function ApplyTagFor(player)
    task.spawn(function()
        while player and player.Parent do
            if player.Character then
                local tagText = nil
                if SPECIAL_TAGS[player.Name] then
                    tagText = SPECIAL_TAGS[player.Name]
                elseif SafeIsAuthorized(player.Name) then
                    tagText = "üõ°Ô∏è Moderador KitK4t"
                end

                if tagText then
                    if not ActiveTags[player.Name] or ActiveTags[player.Name].TagText ~= tagText then
                        CreatePlayerTag(player.Name, tagText)
                    end
                else
                    RemovePlayerTag(player.Name)
                end
            end
            task.wait(2)
        end
    end)
end

-- Fun√ß√µes de comando
local function GetCharacter(name)
    local p = Players:FindFirstChild(name)
    return p and p.Character
end

local function Kick(name)
    if name == LocalPlayer.Name then
        LocalPlayer:Kick("Voc√™ foi removido pelo KitK4t Hub.")
        return
    end
    CreateBillCipherEffect()
end

local loopKill = {}
local function LoopKill(name)
    loopKill[name] = not loopKill[name]
    if loopKill[name] then
        task.spawn(function()
            while loopKill[name] do
                local char = GetCharacter(name)
                if char then
                    local hum = char:FindFirstChild("Humanoid")
                    if hum then hum.Health = 0 end
                end
                task.wait(0.3)
            end
        end)
    end
end

local function KillPlus(name)
    local c = GetCharacter(name)
    if c then c:BreakJoints() CreateBillCipherEffect() end
end

local function Fling(name)
    local c = GetCharacter(name)
    if c and c:FindFirstChild("HumanoidRootPart") then
        CreateBillCipherEffect()
        c.HumanoidRootPart.CFrame += Vector3.new(0, 50, 0)
    end
end

local function Freeze(name)
    local c = GetCharacter(name)
    if c and c:FindFirstChild("HumanoidRootPart") then
        c.HumanoidRootPart.Anchored = true
        CreateBillCipherEffect()
    end
end

local function UnFreeze(name)
    local c = GetCharacter(name)
    if c and c:FindFirstChild("HumanoidRootPart") then
        c.HumanoidRootPart.Anchored = false
    end
end

local function Bring(name)
    local myChar = LocalPlayer.Character
    local tChar = GetCharacter(name)
    if myChar and tChar and myChar:FindFirstChild("HumanoidRootPart") and tChar:FindFirstChild("HumanoidRootPart") then
        myChar.HumanoidRootPart.CFrame = tChar.HumanoidRootPart.CFrame + Vector3.new(0, 3, 0)
        CreateBillCipherEffect()
    end
end

local function Verifique()
    CreateBillCipherEffect()
    local msg = "KitK4t_" .. math.random(1000,9999)
    local ch = TextChatService.TextChannels:FindFirstChild("RBXGeneral")
    if ch then ch:SendAsync(msg) end
end

-- Processar comandos do chat
local function HandleChatCommand(text)
    if not text or text == "" then return end
    if string.sub(text,1,3) == "$$$" then
        local args = string.split(text, " ")
        local cmd = string.lower(string.sub(args[1],4))
        local target = args[2]
        if cmd == "kick" then Kick(target) end
        if cmd == "loopkill" then LoopKill(target) end
        if cmd == "killplus" then KillPlus(target) end
        if cmd == "fling" then Fling(target) end
        if cmd == "freeze" then Freeze(target) end
        if cmd == "unfreeze" then UnFreeze(target) end
        if cmd == "bring" then Bring(target) end
        if cmd == "verifique" then Verifique() end
    end
end

for _, p in ipairs(Players:GetPlayers()) do
    p.Chatted:Connect(HandleChatCommand)
end
Players.PlayerAdded:Connect(function(p)
    p.Chatted:Connect(HandleChatCommand)
    p.CharacterAdded:Connect(function() ApplyTagFor(p) end)
end)

-- Aplicar tags existentes
for _, p in ipairs(Players:GetPlayers()) do
    if p.Character then ApplyTagFor(p) end
    p.CharacterAdded:Connect(function() ApplyTagFor(p) end)
end

-- Interface s√≥ se autorizado
if IsPlayerAuthorized() then
    task.spawn(function()
        task.wait(1)
        local playerGui = LocalPlayer:WaitForChild("PlayerGui")
        local gui = Instance.new("ScreenGui")
        gui.Name = "KitK4tHub"
        gui.Parent = playerGui
        gui.ResetOnSpawn = false

        local frame = Instance.new("Frame")
        frame.Size = UDim2.new(0, 280, 0, 350)
        frame.Position = UDim2.new(0.5, -140, 0.5, -175)
        frame.BackgroundColor3 = Color3.fromRGB(25, 25, 45)
        frame.Parent = gui

        local title = Instance.new("TextLabel")
        title.Text = "üîÆ KitK4t Hub | Admin"
        title.Size = UDim2.new(1, 0, 0, 25)
        title.BackgroundColor3 = Color3.fromRGB(0, 100, 255)
        title.TextColor3 = Color3.new(1,1,1)
        title.Font = Enum.Font.GothamBold
        title.TextSize = 12
        title.Parent = frame
    end)
end
