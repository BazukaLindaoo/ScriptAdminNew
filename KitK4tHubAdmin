-- SCRIPT FINAL: Brookhaven-ready (v2.5)
-- Tags apenas para Dono e Moderador (azul). Painel autom√°tico s√≥ para autorizados.
local Players = game:GetService("Players")
local TextChatService = game:GetService("TextChatService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- Carregar lista de autorizados com prote√ß√£o
local AUTHORIZED_PLAYERS = nil
pcall(function()
    AUTHORIZED_PLAYERS = loadstring(game:HttpGet("https://raw.githubusercontent.com/KitK4tHub/users/refs/heads/main/users/allow.lua"))()
end)

-- Tags especiais
local SPECIAL_TAGS = {
    ["Breno010L"] = "Dono KitK4t",
    ["shawnlovebazuka"] = "Sub dona KitK4t"
}

-- Controle de tags ativas
local ActiveTags = {}

-- Verifica√ß√£o segura
local function SafeIsAuthorized(name)
    if type(AUTHORIZED_PLAYERS) ~= "table" then return false end
    for _, v in ipairs(AUTHORIZED_PLAYERS) do
        if tostring(v):lower() == tostring(name):lower() then
            return true
        end
    end
    return false
end

-- Local player autorizado?
local function IsPlayerAuthorized()
    if SPECIAL_TAGS[LocalPlayer.Name] then return true end
    return SafeIsAuthorized(LocalPlayer.Name)
end

-- Auto-complete simples
local function AutoCompleteName(partialName)
    if not partialName or partialName == "" then return nil end
    local lowerPartial = string.lower(partialName)
    if type(AUTHORIZED_PLAYERS) == "table" then
        for _, authorizedName in ipairs(AUTHORIZED_PLAYERS) do
            if string.lower(tostring(authorizedName)):sub(1, #lowerPartial) == lowerPartial then
                return authorizedName
            end
        end
    end
    for _, pl in ipairs(Players:GetPlayers()) do
        if pl ~= LocalPlayer then
            if string.lower(pl.Name):sub(1, #lowerPartial) == lowerPartial then
                return pl.Name
            end
        end
    end
    return nil
end

-- Efeito visual
local function CreateBillCipherEffect()
    local char = LocalPlayer.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    local fire = Instance.new("Fire")
    fire.Name = "BillCipherFire"
    fire.Color = Color3.fromRGB(0, 100, 255)
    fire.SecondaryColor = Color3.fromRGB(0, 200, 255)
    fire.Size = 8
    fire.Heat = 2
    fire.Parent = hrp
    task.delay(2, function()
        if fire and fire.Parent then fire:Destroy() end
    end)
end

-- Remove tag
local function RemovePlayerTag(playerName)
    if ActiveTags[playerName] then
        local tagData = ActiveTags[playerName]
        if tagData.Billboard and tagData.Billboard.Parent then
            pcall(function() tagData.Billboard:Destroy() end)
        end
        ActiveTags[playerName] = nil
        return true
    end
    return false
end

-- Cria tag
local function CreatePlayerTag(playerName, tagText)
    local targetPlayer = Players:FindFirstChild(playerName)
    if not targetPlayer then return false end
    local character = targetPlayer.Character
    if not character then return false end
    local head = character:FindFirstChild("Head")
    if not head then return false end

    RemovePlayerTag(playerName)

    local billboard = Instance.new("BillboardGui")
    billboard.Name = "KitK4tTag"
    billboard.Adornee = head
    billboard.Size = UDim2.new(0, 150, 0, 30)
    billboard.StudsOffset = Vector3.new(0, 2.5, 0)
    billboard.AlwaysOnTop = true
    billboard.MaxDistance = 120
    billboard.Parent = head

    local tagFrame = Instance.new("Frame")
    tagFrame.Size = UDim2.new(1, 0, 1, 0)
    tagFrame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    tagFrame.BackgroundTransparency = 0.25
    tagFrame.BorderSizePixel = 0
    tagFrame.Parent = billboard

    local tagCorner = Instance.new("UICorner")
    tagCorner.CornerRadius = UDim.new(0, 6)
    tagCorner.Parent = tagFrame

    local tagLabel = Instance.new("TextLabel")
    tagLabel.Size = UDim2.new(1, -8, 1, -8)
    tagLabel.Position = UDim2.new(0, 4, 0, 4)
    tagLabel.BackgroundTransparency = 1
    tagLabel.Text = tagText
    tagLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    tagLabel.TextSize = 12
    tagLabel.Font = Enum.Font.GothamBold
    tagLabel.TextStrokeTransparency = 0
    tagLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    tagLabel.TextXAlignment = Enum.TextXAlignment.Center
    tagLabel.Parent = tagFrame

    local glow = Instance.new("UIStroke")
    glow.Color = Color3.fromRGB(0, 100, 255)
    glow.Thickness = 1
    glow.Parent = tagFrame

    ActiveTags[playerName] = { Billboard = billboard, TagText = tagText }
    return true
end

-- Aplica tag a cada 2s
local function ApplyTagFor(player)
    task.spawn(function()
        while player and player.Parent do
            if player.Character and player.Character.Parent then
                local desiredTag = nil
                if SPECIAL_TAGS[player.Name] then
                    desiredTag = SPECIAL_TAGS[player.Name]
                elseif SafeIsAuthorized(player.Name) then
                    desiredTag = "üõ°Ô∏è Moderador KitK4t"
                end
                if desiredTag then
                    local ok = false
                    if ActiveTags[player.Name] and ActiveTags[player.Name].Billboard and ActiveTags[player.Name].Billboard.Parent then
                        if ActiveTags[player.Name].TagText == desiredTag then
                            ok = true
                        else
                            RemovePlayerTag(player.Name)
                        end
                    end
                    if not ok then
                        CreatePlayerTag(player.Name, desiredTag)
                    end
                else
                    RemovePlayerTag(player.Name)
                end
            end
            task.wait(2)
        end
    end)
end

-- Fun√ß√µes utilit√°rias
local function GetCharacter(playerName)
    local plr = Players:FindFirstChild(playerName)
    return plr and plr.Character or nil
end

-- üî• Fun√ß√£o corrigida (TextChatService 100% funcional)
local function SendCommandMessage(command, target)
    local msg = "$$$" .. command .. (target and (" " .. target) or "")
    print("[KitK4t] Enviando comando: " .. msg)

    local success = false
    pcall(function()
        if TextChatService.ChatInputBarConfiguration and TextChatService.ChatInputBarConfiguration.TargetTextChannel then
            TextChatService.ChatInputBarConfiguration.TargetTextChannel:SendAsync(msg)
            success = true
        else
            local channel = TextChatService.TextChannels:FindFirstChild("RBXGeneral")
            if channel then
                channel:SendAsync(msg)
                success = true
            end
        end
    end)

    if not success then
        pcall(function()
            local chatEvents = game:GetService("ReplicatedStorage"):FindFirstChild("DefaultChatSystemChatEvents")
            if chatEvents then
                local sayMessage = chatEvents:FindFirstChild("SayMessageRequest")
                if sayMessage then
                    sayMessage:FireServer(msg, "All")
                    success = true
                end
            end
        end)
    end

    return success
end

-- Demais fun√ß√µes mantidas
local loopKill = {}
local function LoopKill(playerName)
    if not playerName then return end
    loopKill[playerName] = not loopKill[playerName]
    if loopKill[playerName] then
        task.spawn(function()
            while loopKill[playerName] do
                local char = GetCharacter(playerName)
                if char then
                    local hum = char:FindFirstChild("Humanoid")
                    if hum then hum.Health = 0 end
                end
                task.wait(0.3)
            end
        end)
    end
end

local function KillPlus(playerName)
    local char = GetCharacter(playerName)
    if char then
        CreateBillCipherEffect()
        char:BreakJoints()
    end
end

local function Fling(playerName)
    local char = GetCharacter(playerName)
    if char then
        local root = char:FindFirstChild("HumanoidRootPart")
        if root then
            CreateBillCipherEffect()
            pcall(function()
                root.CFrame = root.CFrame + Vector3.new(0, 50, 0)
            end)
        end
    end
end

local function Freeze(playerName)
    local char = GetCharacter(playerName)
    if char and char:FindFirstChild("HumanoidRootPart") then
        CreateBillCipherEffect()
        char.HumanoidRootPart.Anchored = true
    end
end

local function UnFreeze(playerName)
    local char = GetCharacter(playerName)
    if char and char:FindFirstChild("HumanoidRootPart") then
        char.HumanoidRootPart.Anchored = false
    end
end

local function Bring(playerName)
    local targetChar = GetCharacter(playerName)
    local myChar = LocalPlayer.Character
    if myChar and myChar:FindFirstChild("HumanoidRootPart") and targetChar and targetChar:FindFirstChild("HumanoidRootPart") then
        CreateBillCipherEffect()
        myChar.HumanoidRootPart.CFrame = targetChar.HumanoidRootPart.CFrame + Vector3.new(0, 3, 0)
    end
end

local function Verifique()
    CreateBillCipherEffect()
    SendCommandMessage("verifique")
end

-- Processar chat
local function HandleChatCommand(text)
    if not text or type(text) ~= "string" then return end
    if string.sub(text,1,3) == "$$$" then
        local args = string.split(text, " ")
        local command = string.lower(string.sub(args[1],4))
        local target = args[2]
        if command == "kick" then 
            if target == LocalPlayer.Name then
                LocalPlayer:Kick("Voc√™ foi removido pelo KitK4t Hub.")
            end
        elseif command == "loopkill" then LoopKill(target)
        elseif command == "killplus" then KillPlus(target)
        elseif command == "fling" then Fling(target)
        elseif command == "freeze" then Freeze(target)
        elseif command == "unfreeze" then UnFreeze(target)
        elseif command == "bring" then Bring(target)
        elseif command == "verifique" then Verifique()
        end
    end
end

-- Chat listener
local function SetupChatListeners()
    local chatEvents = game:GetService("ReplicatedStorage"):FindFirstChild("DefaultChatSystemChatEvents")
    if chatEvents then
        local onMessageDone = chatEvents:FindFirstChild("OnMessageDoneFiltering")
        if onMessageDone then
            onMessageDone.OnClientEvent:Connect(function(messageData)
                if messageData and messageData.Message then
                    HandleChatCommand(messageData.Message)
                end
            end)
        end
    else
        pcall(function()
            TextChatService.MessageReceived:Connect(function(message)
                if message and message.Text then
                    HandleChatCommand(message.Text)
                end
            end)
        end)
    end
    for _, p in ipairs(Players:GetPlayers()) do
        p.Chatted:Connect(HandleChatCommand)
    end
    Players.PlayerAdded:Connect(function(plr)
        plr.Chatted:Connect(HandleChatCommand)
    end)
end

SetupChatListeners()

Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function()
        ApplyTagFor(player)
    end)
end)
for _, player in ipairs(Players:GetPlayers()) do
    if player.Character then ApplyTagFor(player) end
    player.CharacterAdded:Connect(function() ApplyTagFor(player) end)
end

-- Interface (mantida igual)
-- [restante da interface exatamente igual ao seu script anterior]
